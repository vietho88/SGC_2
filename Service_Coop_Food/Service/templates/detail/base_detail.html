{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% block add_css %}
    <style>
        .viewer-container {
            background-color: white;
        }

        .image-casorel {
            position: relative;
            border: 1px dashed #a5a79d
        }

        .btn-watch-pdf {
            position: absolute;
            right: 10px;
        }

        .viewer-navbar {
            height: 100px;
            border-top: 1px dotted black;
            background-color: #a29ea5 !important;
        }

        .viewer-list {
            height: 100%;
        }

        .viewer-list li {
            height: 100%;
            width: 70px;
            opacity: 1!important;
        }

        .viewer-list li img {
            height: 100%;
        }

        .viewer-active {
            border: 2px blue solid;
        }

        .form-group {
        {#margin: 0px !important;#}{#padding: 0px !important;#}
        }

        .box-function-top {
            {#margin-bottom: 10px;#}
            {#border-radius: 10px;#}
            background: #17a2b8;
        }

        .box-detail-bill {
        {#border: 1px solid black;#}{#padding: 10px;#}{#border-radius: 10px;#}
        }
        table, th, td {
          border: 1px solid #5e5f59!important;
          border-collapse: collapse!important;
        }
        form table input {
            border: none;
            outline: none;
            width: 100%;
        }
        .viewer-footer{
            {#bottom: 30px!important;#}
        }

        .image-casorel-all{
            min-height: 900px;
        }

        .detail-all-content{
            overflow-y: scroll;
            max-height: 900px
        }

        @media (max-width: 1500px) {
            .image-casorel-all {
                min-height: 800px;
            }

            .detail-all-content {
                max-height: 800px;
            }
        }

        @media (max-width: 1400px) {
            .image-casorel-all {
                min-height: 650px;
            }

            .detail-all-content {
                max-height: 650px;
            }
        }
        @media (max-width: 800px) {
            .detail-all-content {
                max-height: auto;
            }
        }

        .slider {
        width: 50%;
        margin: 100px auto;
        }

        .slick-slide {
          margin: 0px 20px;
        }

        .slick-slide img {
          width: 100%;
        }

        .slick-prev:before,
        .slick-next:before {
          color: black;
        }


        .slick-slide {
          transition: all ease-in-out .3s;
          opacity: .2;
        }

        .slick-active {
          opacity: .5;
        }

        .slick-current {
          opacity: 1;
        }
    </style>

    {% block add_css_detail %}
    {% endblock %}
{% endblock %}

{% block active_header_bill %}
    <li class="nav-item active">
        <a class="nav-link" href="{% url 'home_bill' %}">Hóa Đơn <span class="sr-only">(current)</span></a>
    </li>
{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ request.session.url_old_search_bill }}">Hóa đơn</a></li>
    <li class="breadcrumb-item active" aria-current="page">Chi tiết hóa đơn</li>
    <div class="ml-auto">
        <h6 class="pt-1">{{cus_name}} - {{ bill.upload_date|date:'d/m/Y' }}</h6>
    </div>
{% endblock %}

{% block body %}
    <div id="app">
    <div class="jumbotron" id="content-detail">
        {% if messages %}
            {% for message in messages %}
                <li{% if message.tags %} class="alert-{{ message.tags }} d-none"{% endif %}>{{ message }}</li>
            {% endfor %}
        {% endif %}
        <div class="row">
            <div class="image-casorel col-xl-5 col-lg-6 col-md-12 p-0" >
                <div style="position: relative; bottom: -100px">
                    <div style="position:absolute;z-index: 1; bottom: 60px; left: 20px; font-size: 20px" >
                    {Number(position) + 1}/{{ image_bills|length }}
                    </div>
{#                    <div style="position:absolute;z-index: 1; bottom: 60px; right: 50px; ">#}
{#                        {% if 'Xem PDF hóa đơn điện tử' in request.session.list_per and id_cus in request.session.list_cus_manager  %}#}
{#                        <button class="btn btn-info btn-dowload-file" title="Xem file PDF Hóa đơm" data-toggle="tooltip"  data-message="watchpdf" data-group="{{ bill.group_hd }}" data-check="{{ bill.src_pdf }}">#}
{#                            <i class="far fa-file-pdf"></i></button>#}
{#                        {% endif %}#}
{#                        {% if 'Tải File XML/INV hóa đơn điện tử' in request.session.list_per and id_cus in request.session.list_cus_manager  %}#}
{#                        <button class="btn btn-dark ml-2 btn-dowload-file" title="Tải file XML/INV" data-message="dowloadxml" data-group="{{ bill.group_hd }}" data-check="{{ bill.src_xml }}">#}
{#                            <i class="fas fa-file-invoice"></i></button>#}
{#                        {% endif %}#}
{#                        {% if 'Xem File RECEIVER hóa đơn điện tử' in request.session.list_per and id_cus in request.session.list_cus_manager  %}#}
{#                        <button class="btn btn-success ml-2 btn-dowload-file" title="Xem file RECEIVER" data-message="watchreceiver" data-group="{{ bill.group_hd }}" data-check="{{ bill.src_receiver }}">#}
{#                            <i class="fas fa-file-upload"></i></button>#}
{#                        {% endif %}#}
{#                    </div>#}
                </div>
                <div  class="image-casorel-all">
                    <ul id="images" class="d-none">
                    {{ image_bills }}
                        {% block detail_list_image_casorel %}
                            {% for image in image_bills %}
{#                                <img src="/media/img/{{ image }}" alt="Picture 1">#}
                                {% if is_po %}
                                    <li>
                                    {{ image }}
{#                                    <img src="https://sgc.qlhd.vn/static/img/200916/20200916_145554_1_7_3_1_1_02_false_0023.jpg" alt="Picture 1">#}
                                        <img src="/media/{% if image %}{{ image }}{% else %}img/210119/20210119_090939_1_4_6_1_1_01_false_0007.jpg{% endif %}" alt="Picture 1">
                                    </li>
                                {% else %}
                                    <li>
{#                                    <img src="http://sgc.qlhd.vn/static/img/200714/20200714_145358_VBPO_694_1_66_1_01_false_0094.jpg" alt="Picture 1">#}
                                        <img src="/media/{% if image %}{{ image }}{% else %}img/210119/20210119_090939_1_4_6_1_1_01_false_0007.jpg{% endif %}" alt="Picture 1">
                                    </li>
                                {% endif %}

                            {% endfor %}
                        {% endblock %}
                    </ul>
                </div>
                <div class="d-flex justify-content-between " style="position: relative; top: -35px;" >
                    <a type="button" class="pre_or_next_bar" data-type="next" v-show="bills.length > 4"> <i class="fas fa-chevron-circle-left  fa-2x"></i> </a>
                    <a type="button" class="pre_or_next_bar" data-type="back" v-show="bills.length > 4"> <i class="fas fa-chevron-circle-right fa-2x "></i> </a>
                </div>
            </div>
            <div class="col-xl-7 col-lg-6 col-md-12 detail-all-content" >
                {% block detail_list_btn_menu %}

                {% endblock %}

                {% block detail_box_function_top %}
                    {#                custom chức năng nếu có quyền    #}
                <div class="d-flex justify-content-end mb-1">
                    <!-- phần upload hoad don thay thế loại C -->
                    {% if 'Tải hóa đơn thay thế' in request.session.list_per and id_cus in request.session.list_cus_manager  and status_bill == 'C' %}
                        <a  href="#" class="btn btn-danger m-1" data-target="#modal_up_change_bill" data-toggle="modal" >Tải hóa đơn thay thế <i class="fas fa-qrcode  "></i></a>
                    {% endif %}

                    <!-- phần upload PO  loại H -->
                    {% if 'Tải lên PDF PO' in request.session.list_per and id_cus in request.session.list_cus_manager  and status_bill == 'H' and is_po is False %}
                        <a href="{% url 'report_bill' id_cus id 0 %}" class="btn btn-danger m-1" target="_blank" data-target="#modal_up_po" data-toggle="modal">Tải lên File PDF PO <i class="fas fa-code  "></i></a>
                    {% endif %}

                </div>
                <div class=" box-function-top " >
                    <div class="row text-white">
                        <div class="{% if status_bill == 'O' %} col-md-5{% else %}col-md-8{% endif %} row">
                            <div class="d-flex   mt-1 pt-2 pl-4 pr-4 pb-1 w-100">
                                <p class="m-0">Trạng thái HĐ: <span class="font-weight-bold">{{ status_bill }}</span>
                                </p>
                                {#                        {% if  status_bill == 'S'%}#}
                                <p class="m-0 ml-5">Trạng thái BB: <span
                                        class="font-weight-bold">{{ bill.status_other }}</span></p>
                                {#                        {% endif %}#}
                            </div>

                        </div>


                        {% if  list_per_change_status and id_cus in request.session.list_cus_manager and 'Chuyển trạng thái hóa đơn' in request.session.list_per %}

                            <form class="{% if status_bill == 'O' %} col-md-5{% else %}col-md-2{% endif %}"
                                  id="form-change-status-bill">
                                {% csrf_token %}
                                <div class="row">
                                    {% if  status_bill == 'O' %}
                                        <div class=" col-md-6 p-1">
                                            <select class="custom-select" name="select-industry" id="select-industry"
                                                    {% if status_bill == 'O' %} {% else %} disabled {% endif %}
                                                    required>
                                                {% for type in  list_type_product %}
                                                    {% if bill.type_product_id == type.id %}
                                                        <option value="{{ type.id }}"
                                                                selected> {{ type.name }}  </option>
                                                    {% else %}
                                                        <option value="{{ type.id }}"> {{ type.name }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                                Trang thai O
                                                {% if status_bill == 'O' %}
                                                    <option selected disabled value=""> Chọn Ngành hàng</option>
                                                {% endif %}
                                            </select>
                                        </div>
                                    {% endif %}
                                    <div class="{% if status_bill == 'O' %} col-md-6{% else %}col-md-12{% endif %} p-1">
                                        <select class="custom-select" name="select-status" id="select-status">
                                            {% for change_status in  list_per_change_status %}
                                                <option value="{{ change_status }}"> Chuyển sang
                                                    - {{ change_status }} </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <input type="hidden" class="form-control" name="input-id-group" id="inputId"
                                       placeholder="" value="{{ id }}">
                                <input type="hidden" class="form-control" name="input-old-status" id="inputId"
                                       placeholder="" value="{{ status_bill }}">
                                <input type="hidden" class="form-control" name="input-cus-id" id="inputId"
                                       placeholder="" value="{{ id_cus }}">
                            </form>
                            <button class="btn btn-light {% if status_bill == 'O' %} col-md-2{% else %}col-md-2{% endif %} btn-change-status-bill p-0 mt-1"
                                    style="height: 38px!important; overflow: hidden"><i class="fas fa-exchange-alt  "></i> Chuyển trạng thái
                                </button>
                        {% endif %}

                        {% if bill.status_bill.symbol == 'S' %}
                            <a type="button" class="btn btn-danger col-md-4 mb-1" href="/bill/report/{{ id }}/0"> Xem
                                biên bản </a>
                        {% endif %}
                    </div>

                    {% comment %} <button class="btn btn-danger">Chuyển qua /H</button> {% endcomment %}
                </div>



                {% endblock %}

                {% block detail_box_bill_detail %}
                <div class="box-detail-bill mb-2">
{#                    <h6 class="font-italic ">Chi tiết hóa đơn:</h6>#}
                    <form class="form-change-group-bill" id="form_change_bill" method="post" action="{% url 'detail_bill' id_cus id index %}">
                        {% csrf_token %}
{#                        {% if  is_po %}#}
{#                            <input type="hidden" name="input_hidden_id_bill" value="{{ bill_id_po }}">#}
{#                        {% else %}#}
{#                            <input type="hidden" name="input_hidden_id_bill" value="{{ bill.id }}">#}
{#                        {% endif %}#}
                            <input type="hidden" name="input_hidden_id_bill" v-model="bills[position].id_image">
                            <input type="hidden" name="input_hidden_is_po" v-model="bills[position].is_po">
                            <input type="hidden" name="input_hidden_old_status" v-model="bills[position].status_bill">
                            <input type="hidden" name="input_hidden_position" v-model="position">
                        <div class="p-3" style="border: 1px solid #5e5f59;">
                        <div class="d-flex justify-content-between mt-1 mb-1">
                            <div>
                                {% if 'Chỉnh sửa bộ hóa đơn' in request.session.list_per and id_cus in request.session.list_cus_manager    %}
                                <button type="button" class="btn btn-info btn-edit_group-bill"><i class="fas fa-edit"></i> Sửa hóa đơn</button>
                                <button type="button" class="btn btn-success d-none btn-save-group-bill" ><i class="fas fa-save"></i> Lưu thay đổi</button>
                                <button type="button" class="btn btn-danger d-none btn-reset-group-bill ml-3"><i class="fas fa-undo"></i> Hủy thay đổi</button>
                                {% endif %}
                            </div>
                             <!-- phần biên bản -->
                            {% if status_bill == 'S' and bill.status_other == '' and  'Tạo biên bản' in request.session.list_per and id_cus in request.session.list_cus_manager  %}
                                    <a href="{% url 'report_bill' id_cus id 0 %}" class="btn btn-danger m-1" target="_blank">Tạo biên
                                        bản <i class="fas fa-angle-right  "></i></a>
                            {% elif  status_bill == 'S' and bill.status_other != '' and  'Xem biên bản' in request.session.list_per and id_cus in request.session.list_cus_manager  %}
                                    <a href="{% url 'report_bill' id_cus id 0 %}" target="_blank" class="btn btn-danger">Xem biên
                                        bản <i class="fas fa-angle-right  "></i></a>
                            {% endif %}
                            <div class="menu-button">
                                 {% if 'Xem PDF hóa đơn điện tử' in request.session.list_per and id_cus in request.session.list_cus_manager  %}
                                <button class="btn btn-info btn-dowload-file" type="button" title="Xem file PDF Hóa đơm" data-toggle="tooltip"  data-message="watchpdf" data-group="{{ bill.group_hd }}" data-check="{{ bill.src_pdf }}">
                                    <i class="far fa-file-pdf"></i></button>
                                {% endif %}
                                {% if 'Tải File XML/INV hóa đơn điện tử' in request.session.list_per and id_cus in request.session.list_cus_manager  %}
                                <button class="btn btn-dark ml-2 btn-dowload-file" type="button" title="Tải file XML/INV" data-message="dowloadxml" data-group="{{ bill.group_hd }}" data-check="{{ bill.src_xml }}">
                                    <i class="fas fa-file-invoice"></i></button>
                                {% endif %}
                                {% if 'Xem File RECEIVER hóa đơn điện tử' in request.session.list_per and id_cus in request.session.list_cus_manager  %}
                                <button class="btn btn-success ml-2 btn-dowload-file" type="button" title="Xem file RECEIVER" data-message="watchreceiver" data-group="{{ bill.group_hd }}" data-check="{{ bill.src_receiver }}">
                                    <i class="fas fa-file-upload"></i></button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="">
                            <label for="inuput-name-city">Tên công ty :<span class="font-weight-bold span-info-detail" v-show="!is_edit"> { bills[position].city_name } </span></label>
                            <input type="text" class="form-control input_info_detail" v-show="is_edit" id="input-name-company" name="input-name-company" disabled v-model="bills[position].city_name">
                        </div>
                        <div class="">
                            <label for="input-address">Địa chỉ :<span class="font-weight-bold span-info-detail mb-3" v-show="!is_edit"> { bills[position].city_address}  </span></label>
                            <input type="text" class="form-control input_info_detail mb-3"  v-show="is_edit" id="input-address-company" name="input-address-company" disabled v-model="bills[position].city_address">
                        </div>
                        <div class="form-row">
                            <div class="col-md-4 mb-1">
                                <label for="select-industry">Ngành Hàng : <span class="font-weight-bold span-info-detail" v-show="!is_edit">
                                   {% for type in  list_type_product %}
                                        {% if bill.type_product_id == type.id %}
                                            {{ type.name }}
                                        {% endif %}
                                    {% endfor %}
{#                                    Trang thai O#}
                                    {% if status_bill == 'O' %}
                                        HDDT-TTPP
                                    {% endif %}

                                </span></label>
                                <!-- Neu là trạng thái O thì phải bắt buộc chọn ngành hàng -->
                                <select class="custom-select" name="select-industry" id="select-industry" required v-show="is_edit">
                                    {% for type in  list_type_product %}
                                        {% if bill.type_product_id == type.id %}
                                            <option value="{{ type.id}}" selected> {{ type.name }}  </option>
                                        {% else %}
                                            <option value="{{ type.id}}"> {{ type.name }}</option>
                                        {% endif %}

                                    {% endfor %}
{#                                    Trang thai O#}
                                    {% if status_bill == 'O' %}
                                        <option value="10" selected> HDDT-TTPP</option>
                                    {% endif %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-1">
                                <label for="input-tax-number">Mã Số Thuế : <span class="font-weight-bold span-info-detail" v-show="!is_edit">{ bills[position].tax_number } </span></label>
                                <input type="text" class="form-control input_info_detail" v-show="is_edit" id="input-tax-number" name="input-tax-number" disabled v-model="bills[position].tax_number">
                            </div>
                            <div class="col-md-4 mb-1 ">
                                <label for="input-date-bill">Ngày hóa đơn :<span class="font-weight-bold span-info-detail" v-show="!is_edit"> { bills[position].bill_date } </span></label>
                                <input type="text" class="form-control input_info_detail" v-show="is_edit" id="input-date-bill"  name="input-date-bill" disabled v-model="bills[position].bill_date">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-4 mb-1">
                                <label for="input-symbol-bill">Ký hiệu hóa đơn :<span class="font-weight-bold span-info-detail" v-show="!is_edit"> { bills[position].symbol }  </span></label>
                                <input type="text" class="form-control input_info_detail" v-show="is_edit" id="input-symbol-bill" name="input-symbol-bill" disabled v-model="bills[position].symbol">
                            </div>
                            <div class="col-md-4 mb-1">
                                <label for="input-bill-number">Số hóa đơn :<span class="font-weight-bold span-info-detail" v-show="!is_edit"> { bills[position].number_bill } </span></label>
                                <input type="text" class="form-control  input_info_detail" v-show="is_edit" id="input-bill-number" name="input-bill-number" disabled v-model="bills[position].number_bill" @keypress="isNumberInput($event)">
                            </div>
                            <div class="col-md-4 mb-1">
                                <label for="input-po-number">Số PO/Tranfer :<span class="font-weight-bold span-info-detail" v-show="!is_edit"> { bills[position].po_number } </span></label>
                                <input type="text" class="form-control input_info_detail" v-show="is_edit" id="input-po-number" name="input-po-number" disabled v-model="bills[position].po_number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-4 mb-1">
                                <label for="input-po-money">Tổng tiền PO :<span class="font-weight-bold span-info-detail" v-show="!is_edit"> { bills[position].sum_po | toCurrency} </span></label>
                                <input type="text" class="form-control  input_info_detail" v-show="is_edit" id="input-po-money" name="input-po-money" disabled v-model="bills[position].sum_po" @keypress="isFloatInput($event)">
                            </div>
                            <div class="col-md-4 mb-1">
                                <label for="input-vendor-code">Mã Vendor :<span class="font-weight-bold span-info-detail" v-show="!is_edit"> { bills[position].vendor_number } </span></label>
                                <input type="text" class="form-control input_info_detail" v-show="is_edit" id="input-vendor-code" name="input-vendor-code" disabled v-model="bills[position].vendor_number">
                            </div>
                            <div class="col-md-4 mb-1">
                                <label for="input-receiver-code">Mã Receiver :<span class="font-weight-bold span-info-detail" v-show="!is_edit"> { bills[position].receiver_number } </span></label>
                                <input type="text" class="form-control input_info_detail" v-show="is_edit" id="input-receiver-code" name="input-receiver-code" disabled v-model="bills[position].receiver_number" @keypress="isNumberInput($event)">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-4 mb-1">
                                <label for="input-date-bill-out">Ngày sửa cuối : <span class="font-weight-bold span-info-detail" v-show="!is_edit"> {{bill.last_change_date|date:'d/m/Y' }}  {{ bill.last_change_date|time:"H:i:s" }}</span></label>
                                <input type="text" class="form-control input_info_detail" v-show="is_edit" id="input-date-bill-out" name="input-date-bill-out" disabled value="{% if bill.last_change_date %}{{ bill.last_change_date|date:'d/m/Y h:m:s' }}{% endif %}" readonly>
                            </div>
{#                            <div class="col-md-4 mb-1">#}
{#                                <label for="input-tax-number">Mã Số Thuế </span></label>#}
{#                                <input type="text" class="form-control" id="input-tax-number" name="input-tax-number" disabled value="{{ bill.tax_number }}">#}
{#                            </div>#}
                            <div class="col-md-4 mb-1">
                                <label for="input-date-bill-up">Ngày tải lên :<span class="font-weight-bold span-info-detail" v-show="!is_edit"> {{ bill.upload_date|date:'d/m/Y'  }} {{ bill.upload_date|time:"H:i:s" }}</span></label>
                                <input type="text" class="form-control input_info_detail" v-show="is_edit" id="input-date-bill-out" name="input-date-bill-out" disabled value="{{ bill.upload_date|date:'d/m/Y'  }} {{ bill.upload_date|time:"H:i:s" }}" readonly>
                            </div>
                        </div>

                        </div>
{#                        {% if is_po  %}#}
                            <div class="table-responsive mt-3" v-if="bills[position].is_po">
                                <table class="table table-bordered table-sm table-result-check-luoi">
                                    <thead class="text-center">
                                    <tr>
                                        <th class="align-middle">No.</th>
                                        <th class="align-middle">Mã SKU</th>
                                        <th class="align-middle">Đơn Giá</th>
                                        <th class="align-middle">Số Lượng Trước Sửa</th>
                                        <th class="align-middle">Số Lượng Sau Sửa</th>
                                        <th class="align-middle">Thành Tiền</th>
                                    </tr>
                                    </thead>
                                    <tbody class="text-center">
                                            <tr v-for="(line, index) in bills[position].result_check_luoi">
                                                <td> {index + 1} </td>
                                                <td>
                                                    <input type="text" v-model="line[0]" name="input-result_check_luoi[]" :disabled="!is_edit" >
                                                </td>
                                                <td>
                                                    <span v-show="!is_edit" >{line[1] | toCurrency}</span>
                                                    <input type="text" v-model="line[1]" name="input-result_check_luoi[]" :disabled="!is_edit"  v-show="is_edit"  class="input-curency " @keypress="isFloatInput($event)">
                                                </td>
                                                <td>
                                                    <input type="text" v-model="line[2]" name="input-result_check_luoi[]" :disabled="!is_edit">
                                                </td>
                                                <td>
                                                    <input type="text" v-model="line[3]" name="input-result_check_luoi[]" :disabled="!is_edit">
                                                </td>
                                                <td>
                                                    <span v-show="!is_edit">{line[4] | toCurrency}</span>
                                                    <input type="text" v-model="line[4]" name="input-result_check_luoi[]" :disabled="!is_edit"  v-show="is_edit"  class="input-curency " @keypress="isFloatInput($event)">
                                                </td>
                                            </tr>
                                    </tbody>
                                </table>
                                <div class="d-flex justify-content-end  div-add-line mb-2" id="div-add-line">
                                    <button type="button" class="btn btn-success d-none" title="Thêm một dòng mới">+</button>
                                    <button type="button" class="btn btn-danger ml-1 d-none" title="Xóa dòng cuối">-</button>
                                </div>
                            </div>
{#                        {% else %}#}
                            <div class="table-responsive mt-3" v-else>
{#                                                        <div class="p-1 pt-3 pb-3" style="border: 1px solid black; border-radius: 10px">#}
                                <table class="table table-bordered table-sm  table-result-check-luoi ">
                                    <thead class="text-center">
                                    <tr>
                                        <th style="" class="align-middle">No.</th>
                                        <th style="min-width: 100px; " class="align-middle">Mã hàng hóa</th>
                                        <th style="min-width: 200px; " class="align-middle">Tên hàng hóa</th>
                                        <th style="min-width: 100px; " class="align-middle">Đơn vị</th>
                                        <th style="min-width: 100px; " class="align-middle">Số lượng</th>
                                        <th style="min-width: 100px; " class="align-middle">Đơn giá</th>
                                        <th style="min-width: 100px; " class="align-middle">Thuế VAT</th>
                                        <th style="min-width: 100px; " class="align-middle">Tiền thuế VAT</th>
                                        <th style="min-width: 100px; " class="align-middle">Thành tiền</th>
                                    </tr>
                                    </thead>
                                    <tbody class="text-center">
{#                                    {% for line in result_check_luoi %}#}
                                        <tr v-for="(line, index) in bills[position].result_check_luoi">
                                            <td>{index + 1}</td>
                                            <td><input type="text" v-model="line[0]" name="input-result_check_luoi[]" :disabled="!is_edit">
                                            </td>
                                            <td>
                                                <input type="text" v-model="line[1]" name="input-result_check_luoi[]" :disabled="!is_edit">
                                            </td>
                                            <td>
                                                <input type="text" v-model="line[2]"  name="input-result_check_luoi[]" :disabled="!is_edit">
                                            </td>
                                            <td>
                                                <input type="text" v-model="line[3]" name="input-result_check_luoi[]" :disabled="!is_edit">
                                            </td>
                                            <td>
                                                <input type="text" v-model="line[4]" name="input-result_check_luoi[]" :disabled="!is_edit">
                                            </td>
                                            <td>
                                                <span v-show="!is_edit">{line[5] | toCurrency}</span>
                                                <input type="text" v-model="line[5]" name="input-result_check_luoi[]" :disabled="!is_edit"  v-show="is_edit" class=" input-curency" @keypress="isFloatInput($event)">
                                            </td>
                                            <td>
                                                <span v-show="!is_edit">{line[6] | toCurrency}</span>
                                                <input type="text" v-model="line[6]" name="input-result_check_luoi[]" :disabled="!is_edit" v-show="is_edit" class=" input-curency" @keypress="isFloatInput($event)">
                                            </td>
                                            <td>
                                                <span v-show="!is_edit">{line[7] | toCurrency}</span>
                                                <input type="text" v-model="line[7]" name="input-result_check_luoi[]" :disabled="!is_edit" v-show="is_edit" class=" input-curency" @keypress="isFloatInput($event)">
                                            </td>

                                        </tr>

                                    </tbody>
                                </table>
                                <div class="d-flex justify-content-end  div-add-line mb-2" id="div-add-line">
                                    <button type="button" class="btn btn-success d-none" title="Thêm một dòng mới">+</button>
                                    <button type="button" class="btn btn-danger ml-1 d-none" title="Xóa  dòng cuối">-</button>
                                </div>
{#                                                        </div>#}
                            </div>
{#                        {% endif %}#}

{#                        {% if not is_po %}#}
                        <div class="mt-2" v-if="!bills[position].is_po">
{#                            <div class="p-1 pt-3 pb-3" style="border: 1px solid black; border-radius: 10px">#}
                            <table class="table table-bordered table-sm table-result-check mt-1 " style="border:1px solid black!important;">
                                <thead class="text-center">
                                <tr>
                                    <th>VAT(%)</th>
                                    <th>Thành tiền chưa thuế</th>
                                    <th>Tiền thuế</th>
                                    <th>Tiền sau thuế</th>
                                </tr>
                                </thead>
                                <tbody class="text-center">
                                <tr>
                                    <td><div class="d-flex justify-content-center"> <input type="text" v-model="bills[position].result_check[0]" name="input-result_check[]" readonly style="width: 15px">%</div></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[1] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[1]" name="input-result_check[]" disabled ></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[2] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[2]"  name="input-result_check[]" disabled ></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[3] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[3]"  name="input-result_check[]" disabled ></td>
                                </tr>
                                <tr>
                                    <td><div class="d-flex justify-content-center"> <input type="text"  v-model="bills[position].result_check[4]" name="input-result_check[]" readonly style="width: 15px">%</div></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[5] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[5]"  name="input-result_check[]" disabled ></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[6] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[6]"  name="input-result_check[]" disabled ></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[7] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[7]"  name="input-result_check[]" disabled ></td>
                                </tr>
                                <tr>
                                    <td><div class="d-flex justify-content-center"> <input type="text"  v-model="bills[position].result_check[8]" name="input-result_check[]" readonly style="width: 25px">%</div></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[9] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[9]"  name="input-result_check[]" disabled ></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[10] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[10]"   name="input-result_check[]" disabled ></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[11] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[11]"   name="input-result_check[]" disabled ></td>
                                </tr>
                                <tr>
                                    <td><input type="text"  v-model="bills[position].result_check[12]"  name="input-result_check[]" readonly class="d-none">Khác</td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[13] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[13]"  name="input-result_check[]" disabled ></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[14] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[14]"  name="input-result_check[]" disabled ></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[15] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[15]"  name="input-result_check[]" disabled ></td>
                                </tr>
                                <tr>
                                    <td>Tổng cộng</td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[16] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[16]"  name="input-result_check[]" disabled></td>
                                    <td><span v-show="!is_edit">{bills[position].result_check[17] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[17]"  name="input-result_check[]" disabled></td>
{#                                    <td><input type="text" v-show=is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[18]"  name="input-result_check[]" disabled></td>#}
                                    <td><span v-show="!is_edit">{bills[position].result_check[18] | toCurrency}</span><input type="text" v-show="is_edit" class="text-center" @keypress="isFloatInput($event)" v-model="bills[position].result_check[18]"  name="input-result_check[]" disabled></td>
                                </tr>
                                </tbody>
                            </table>
{#                                                    </div>#}
                        </div>
{#                        {% endif %}#}

                        <div class="d-flex justify-content-end">
                            <button v-show="!is_edit" type="button" class="btn btn-info btn-wath-log" > Xem lịch sử hóa đơn </button>
                            <button v-show="!is_edit" type="button" class="btn btn-info btn-watch-rpa ml-1" > Xem trạng thái Robot hiện tại </button>
                        </div>
                    </form>
                </div>
                {% endblock %}
            </div>
        </div>
    </div>


    <!-- Modal show log -->
    <div class="modal fade" id="modal_show_log" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-center">Xem lịch sử thay đổi hóa đơn</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div>
                        <h6>Lịch sử chuyển trạng thái</h6>
                        <ul class="content_log_change_status">
                        </ul>
                    </div>
                    <div>
                        <h6>Lịch sử chỉnh sửa hóa đơn</h6>
                        <ul class="content_log_edit_bill">
                        </ul>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal show status rpa-->
    <div class="modal fade" id="modal_show_rpa" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="text-center show_status_rpa">STATUS ROBOT :</p>
                </div>
            </div>
        </div>
    </div>

        <!-- modal uploahoa thay the -->
    {% if 'Tải hóa đơn thay thế' in request.session.list_per and id_cus in request.session.list_cus_manager  and status_bill == 'C'  %}
    <div class="modal fade" id="modal_up_change_bill" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tải lên hóa đơn thay thế</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <h6>Vui lòng sử dụng App và quét mã QR bên dưới để tải lên hóa đơn thay thế !!</h6>
{#                    <img src="{% static 'public/images/logo.png' %}" style="width: 150px; height: 150px">#}
                    <div class="d-flex justify-content-center">
                        <div  id="qrcode" style="width:150px; height:150px; margin-top:15px;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- modal uploahoa pdf po-->
    {% if 'Tải lên PDF PO' in request.session.list_per and id_cus in request.session.list_cus_manager   and status_bill == 'H' and is_po is False  %}
    <div class="modal fade" id="modal_up_po" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tải lên File PDF PO </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <h6 >Chọn File PDF cần tải lên rồi nhấn nút "Tải lên PO" để tải lên file DPF PO</h6>
                        <form  id="form_upload_po" class="mt-2" enctype="multipart/form-data" >
                            {% csrf_token %}
                            <input type="hidden" class="form-control" name="input-cus-id"  placeholder="" value="{{ id_cus }}">
                            <input type="hidden" class="form-control" name="input-bill-id"  placeholder="" value="{{ bill.id }}">
                            <div class="mb-2">
                                <button type="button" class="btn btn-info" style="min-width: 200px" onclick="document.getElementById('input_file_upload_po').click()">Chọn file tải lên</button>
                                <input type="file" class="d-none" id="input_file_upload_po" name="input_file_upload_po" accept="application/pdf" required>
                                <p class="name_file_po_upload mt-1">  </p>
                            </div>
                            <div>
                                <button type="button" class="btn-info btn w-25 btn_submit_up_po" style="min-width: 200px" disabled>Tải lên PDF PO <i class="fas fa-upload  "></i></button>
                            </div>
                        </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    </div>
{% endblock %}

{% block add_js %}
    {% block add_js_detail %}
{#            CUstom lại file viewer để loại TH load image ở thumnail đổi trang CTHD#}
            <script defer src="{% static 'vendor/qr_code/qrcode.min.js' %}" type="text/javascript"></script>
            <script  src="{% static 'vendor/iviewer/jquery-viewer.js' %}"></script>
            <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
            <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    {% endblock %}
    <script>
        $(document).ready(function () {
            var old_data = []
            var app = new Vue({
                    delimiters: ['{', '}'],
                    el: '#app',
                    data: {
                        position : 0,
                        is_edit : false,
                        bills : [
                            {
                                id_image : 1,
                                old_status : 'O',
                                is_po: false,
                                type_bill: '',
                                status_HD: '',
                                city_name: '',
                                city_address: '',
                                type_product: '',
                                tax_number: '',
                                bill_date: '',
                                symbol: '',
                                number_bill: '',
                                po_number: '',
                                sum_po: '',
                                vendor_number: '',
                                receiver_number: '',
                                upload_date: '',
                                last_change_date: '',
                                result_check: [
                                    '', '', '', '', '', '',
                                ],
                                result_check_luoi: [
                                    [0, 0, 0, 0, 0, 0, 0, 0],
                                    [0, 0, 0, 0, 0, 0, 0, 0],
                                    [0, 0, 0, 0, 0, 0, 0, 0],
                                ],
                                status_rpa : ''
                            }
                        ]
                    },
                    methods : {
                        isNumberInput: function(event) {
                            event = (event) ? event : window.event;
                            var charCode = (event.which) ? event.which : event.keyCode;
                            if (charCode == 8 || charCode == 0 || charCode == 65 || charCode == 91 || charCode == 93 || charCode == 81) {
                                if (charCode == 91 && event.target.value.indexOf('[') != -1) {
                                    event.preventDefault();
                                }
                                if (charCode == 81 && (event.target.value.indexOf('Q') != -1 || event.target.value.indexOf('[') == -1)) {
                                    event.preventDefault();
                                }
                                if (charCode == 65 && (event.target.value.indexOf('A') != -1 || event.target.value.indexOf('[Q') == -1)) {
                                    event.preventDefault();
                                }
                                if (charCode == 93 && (event.target.value.indexOf(']') != -1 || event.target.value.indexOf('[QA') == -1)) {
                                    event.preventDefault();
                                }
                                return true;
                            }
                            if (charCode < 48 || charCode > 57) {
                                event.preventDefault();
                            }
                            
                        },
                        isFloatInput: function(event) {
                            event = (event) ? event : window.event;
                            var charCode = (event.which) ? event.which : event.keyCode;
                            if (charCode == 8 || charCode == 0 || charCode == 65 || charCode == 91 || charCode == 93 || charCode == 81 || charCode == 46) {
                                if (charCode == 91 && event.target.value.indexOf('[') != -1) {
                                    event.preventDefault();
                                }
                                if (charCode == 81 && (event.target.value.indexOf('Q') != -1 || event.target.value.indexOf('[') == -1)) {
                                    event.preventDefault();
                                }
                                if (charCode == 65 && (event.target.value.indexOf('A') != -1 || event.target.value.indexOf('[Q') == -1)) {
                                    event.preventDefault();
                                }
                                if (charCode == 93 && (event.target.value.indexOf(']') != -1 || event.target.value.indexOf('[QA') == -1)) {
                                    event.preventDefault();
                                }
                                if (charCode == 46 && event.target.value.indexOf('.') != -1) {
                                    event.preventDefault();
                                }
                                return true;
                            }
                            if (charCode < 48 || charCode > 57) {
                                event.preventDefault();
                            }

                        }
                    },
                    filters: {
                        toCurrency: (value) => {
                            if(value != '' && value != '[QA]'){
                                return parseFloat(value).toLocaleString()
                            }else{
                                return value
                            }

                        }
                    },
                    mounted: function () {
                        var vue_el = this
                        axios.get('/ajax/detail_bill/get_info_detail_bill', {
                            params : {
                                'group_hd' : '{{ id }}',
                                'id_cus' : '{{ id_cus }}',
                                'position' : '{{ index }}',
                            }
                            })
                            .then(function (response) {
                                vue_el.position = response.data.data.position
                                vue_el.bills = response.data.data.bills
                                old_data = response.data.data.bills
                                localStorage["old_data"] = JSON.stringify(response.data.data.bills);
                            })

                    },
                    updated() {
                        //Đánh dấu QA
                        $('.form-change-group-bill input, .form-change-group-bill span').each(function () {
                            if ($(this).val().match(/\[QA\]/g) || $(this).text().match(/\[QA\]/g)) {
                                $(this).css('background', 'yellow')
                            }
                            else{
                                $(this).css('background', 'white')
                            }
                        })
                    },

            })

            //move nav thumbail iamge
            $('.pre_or_next_bar').click(function () {
                var sum = parseInt($('.viewer-navbar .viewer-list').css('transform').split(',')[4])
                if($(this).data('type') == 'next'){
                    sum -= 50
                }else{
                    sum += 50
                }
                $('.viewer-navbar .viewer-list').css('transform', 'translateX('+sum+'px)')
            })

            var img = $('#images').viewer({
                    inline: true,
                    title: false,
                    toolbar: {
                        zoomIn: 4,
                        zoomOut: 4,
                        oneToOne: 4,
                        rotateLeft: 4,
                        rotateRight: 4,
                    },
                    movable: true,
                    tooltip: false,
                    fullscreen: false,
                    initialViewIndex : {{ index }},
                    loading : true,
                }
            );

            $('.image-casorel').on('click', '.viewer-list  li img', function (e) {
                if(app.is_edit){
                    alert("Hãy lưu hoặc bỏ chỉnh sửa trước khi chuyển qua ảnh mới!")
                    e.preventDefault()
                    return false
                }
                else {
                    app.position = $(this).data('index')
                }
            })

            //Edit
            $('.btn-edit_group-bill').on('click', function(){
                $('.form-change-group-bill input, .form-change-group-bill select').removeAttr('disabled')
                $('.btn-save-group-bill').toggleClass('d-none')
                $('.btn-reset-group-bill').toggleClass('d-none')
                $('.btn-edit_group-bill').addClass('d-none')
                $('.div-add-line button').toggleClass('d-none')
                app.is_edit = true
                $(".viewer-navbar").addClass('d-none');
            })

            //reset
            $('.btn-reset-group-bill').on('click', function(){
                $('.form-change-group-bill input, .form-change-group-bill select').attr('disabled', 'disabled')
                $('.btn-save-group-bill').toggleClass('d-none')
                $('.btn-reset-group-bill').toggleClass('d-none')
                $('.btn-edit_group-bill').toggleClass('d-none')
                $('.div-add-line button').toggleClass('d-none')
                app.bills = JSON.parse(localStorage["old_data"]);
                app.is_edit = false
                $(".viewer-navbar").toggleClass('d-none');
            })

            ///add-remove line
            $('.table-responsive').on('click', '.btn-success', function () {
                console.log("click")
                number_stt_last = parseInt($('.table-result-check-luoi').find('tbody tr:last td:first').text())
                if(number_stt_last){
                    number_stt_last+=1
                }
                else{
                    number_stt_last = 1
                }
                if( app.bills[app.position].is_po == true){
                    app.bills[app.position].result_check_luoi.push(['', '', '', '', '', ''])
                }
                else{
                    app.bills[app.position].result_check_luoi.push(['', '', '', '', '', '','', ''])
                }
            })

            $('.table-responsive ').on('click', '.btn-danger' , function () {
                if($('.table-result-check-luoi').find('tbody tr').length > 1){
                    if( app.bills[app.position].is_po == true){
                        app.bills[app.position].result_check_luoi.pop(['', '', '', '', '', ''])
                    }
                    else{
                        app.bills[app.position].result_check_luoi.pop(['', '', '', '', '', '','', ''])
                    }
                }else{
                    alert('Không thể xóa hàng đầu')
                }

            })

            $('.btn-save-group-bill').on('click', function(){
                let reg = /^((\[QA\])|(0[1-9]|[12][0-9]|3[01])[/](0[1-9]|1[012])[/](19|20)\d{2})$/
                if(reg.test($('#input-date-bill').val()) == false){
                    Swal.fire({
                        title : "Lỗi định dạng ngày hóa đơn(dd/mm/YYYY)"
                    })
                    return false
                }

                if($('#input-bill-number').val() == ''){
                    Swal.fire({
                        title : "Số hóa đơn không được để trống"
                    })
                    return false
                }

                Swal.fire({
                    title: 'Bạn có chắc chắn?',
                    text: "Muốn chỉnh sửa thông tin bộ hóa đơn này!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Có , Tôi muốn!',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed){
                        $(".form-change-group-bill").submit()
                    }

                })
            })

            $('.btn-change-status-bill').on('click', function(){
                //Xét trường hợp từ loại
                switch ('{{ status_bill }}') {
                    case 'O' :
                        //Nếu là loại O thì bắt buộc chọn ngành hàng
                        if (!$('#form-change-status-bill #select-industry').val()) {
                            alertSwalTopRight('info', 'Bạn phải chọn ngành hàng khi chuyển từ trạng thái O!!')
                            return false
                        }
                        break;

                    case 'W':
                        //Nếu từ W - > trạng thái khác (NGoại trừ O, S) thì bắt buộc không còn QA mới được chuyển
                        if(!($("#select-status").val() in ['O', 'S']) && '{{bill.is_qa}}' == '1'){
                            alertSwalTopRight('info', 'Đang bị đánh dấu [QA] nên không thể chuyển sang trạng thái  '+$("#select-status").val()+'!')
                            return false
                        }
                        break;

                    case 'A':
                        if($("#select-status").val() == 'R' && '{{ bill.receiver_number }}' == ''){
                            alertSwalTopRight('info', 'Hóa đơn từ A - R phải có mã Receiver!')
                            return false
                        }
                        break;
                }

                // Xét trường hợp đến loại
                switch ($("#select-status").val()) {
                    //Nếu qua R thì ngoại trừ HDDT TTPP thì bắt buộc phải có số receiver
                    case 'R' :
                        if('{{bill.is_qa}}' == '1'){
                            alertSwalTopRight('info', 'Đang bị đánh dấu [QA] nên không thể chuyển sang trạng thái R!')
                            return false
                        }
                        if ('{{ bill.is_ttpp }}' != 1 && '{{ bill.receiver_number }}' == ''){
                            alertSwalTopRight('info', 'Chưa có mã Receiver nên không thể chuyển sang trạng thái R!')
                            return false
                        }

                    case 'V' :
                    case 'F' :
                        if('{{bill.is_qa}}' == '1'){
                            alertSwalTopRight('info', 'Đang bị đánh dấu [QA] nên không thể chuyển sang trạng thái '+$("#select-status").val()+'!')
                            return false
                        }
                        if ('{{ bill.is_ttpp }}' != 1 && '{{ bill.receiver_number }}' == '' && '{{ bill.po_number }}'.indexOf('I') == -1 ){
                            alertSwalTopRight('info', 'Chưa có mã Receiver nên không thể chuyển sang trạng thái '+$("#select-status").val()+'!')
                            return false
                        }
                }
                Swal.fire({
                    title: 'Bạn có chắc chắn?',
                    text: "Muốn Chuyển hóa đơn này sang trạng thái " + $("#select-status").val(),
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Có, Tôi muốn!'
                }).then((result) => {
                    if (result.isConfirmed == true ){
                        form_data = new FormData(document.getElementById('form-change-status-bill'))
                        form_data.append('type_product', $('#form-change-status-bill #select-industry').val() )
                        $.ajax({
                            url : "{% url 'ajax_update_status' %}",
                            type : "post",
                            data : form_data,
                            processData: false,
                            contentType: false,
                            success: function(data){
                                if(data.message == 'success'){
                                    alertSwalTopRight('success', 'Chuyển trạng thái thành công!!')
                                    window.location.reload()
                                }else  if(data.message == 'errorqa'){
                                    alertSwalTopRight('info', 'Bộ hóa đơn đang QA, không thể chuyển trạng thái !!')
                                }else  if(data.message == 'erroenough'){
                                    alertSwalTopRight('info', 'Bộ hóa đơn này chưa có đầy đủ thông tin !!')
                                }
                                else{
                                    alertSwalTopRight('error', 'Đã có lỗi xảy ra, vui lòng thử lại sau!!')
                                }
                            },
                            error: function(data){

                            }
                        })
                    }
                })  
            })

            $('.menu-button button').on('click', function () {
                messsge = $(this).data('message')
                group_hd = $(this).data('group')
                check = $(this).data('check')
                switch (messsge) {
                    case  'watchpdf':
                        if ('{{ bill.src_pdf }}' != '' && '{{ bill.src_pdf }}' != 'None' ){
                        window.open('/media/{{ bill.src_pdf }}','blank_')
                        }else {
                            alertSwalTopRight('info', 'Bộ hóa đơn này chưa tải lên file pdf!!')
                        }
                        break;
                    case 'dowloadxml':
                        if ('{{ bill.src_xml }}' != '' && '{{ bill.src_xml }}' != 'None'){
                        window.open('{% url 'dowload_media_file' 'xml' id bill.id id_cus %}')
                        }else {
                            alertSwalTopRight('info', 'Bộ hóa đơn này chưa tải lên file xml!!')
                        }
                        break;
                    case 'watchreceiver':
                        if ('{{ bill.src_receiver }}' != '' && '{{ bill.src_receiver }}' != 'None' ){
                        window.open('/media/{{ bill.src_receiver }}','blank_')
                        }else {
                            alertSwalTopRight('info', 'Bộ hóa đơn này chưa tải lên file receiver!!')
                        }
                        break;
                }

            })

            if($('.alert-success').text()){
                alertSwalTopRight('success', 'Sửa thông tin thành công!!')
            }

            $('#input_file_upload_po').change(function () {
                $(".name_file_po_upload").text($(this).val())

                if($(this).val() != ''){
                    $('.btn_submit_up_po').removeAttr('disabled')
                }
                else {
                    $('.btn_submit_up_po').attr('disabled', 'disabled')
                }
            })

            $("#modal_up_po, #modal_up_change_bill").on("hidden.bs.modal", function(){
                $('#input_file_upload_po').val('');
                $(".name_file_po_upload").text('')
                $("#qrcode").html('')
                $('.btn_submit_up_po').attr('disabled','disabled')
            });

            $("#modal_up_change_bill").on("show.bs.modal", function () {
                var qrcode = new QRCode(document.getElementById("qrcode"), {
                    width : 150,
                    height : 150
                });
                console.log('{{ content_qr }}')
                qrcode.makeCode('{{ content_qr }}');
            })

            /*btn watch log, history change státus, history update HĐ
                send ajax to show hisory
             */
            $('.btn-wath-log').on('click', function () {
                let bill_id = app.bills[app.position].id_image;
                let id_cus = '{{ id_cus }}';
                let group = '{{ id }}';
                $.ajax({
                    url : `/ajax/detail_bill/get_log/${id_cus}/${group}/${bill_id}`,
                    type : 'GET',
                    data : {
                    },
                    success: function (data) {
                        if (jQuery.isEmptyObject(data)){
                            alertSwalTopRight('info', "Chưa có lịch sử thay đổi.")
                        }
                        else {
                            let html_log_edit = '';
                            let html_log_change = '';
                            data.log_change_detail_bill.forEach((log) =>{
                                html_log_edit+= `<li> Thời gian: ${new Date(log[1]).toLocaleString('vi')}| User: ${log[0]}| Trường thay đổi: ${log[2]} </li>`
                            });
                            data.log_change_status.forEach((log) =>{
                                 html_log_change += `<li> Thời gian: ${new Date(log[4]).toLocaleString('vi')}| User: ${log[3]}| Chuyển ${ log[0] == '1' ?  'trạng thái ' : 'trạng thái hàng loạt ' } từ ${log[1]} sang ${log[2]} </li>`
                            });
                            $('.content_log_edit_bill').html(html_log_edit);
                            $('.content_log_change_status').html(html_log_change);
                            $('#modal_show_log').modal({
                                 backdrop: 'static',
                                keyboard: false,
                                show: true
                            });
                            $("#modal_show_log").draggable({
                                handle: ".modal-header"
                            });
                        }
                    }
                })
            })

            //open modal show status rpa
            $('.btn-watch-rpa').on('click', ()=>{
                let status_rpa = app.bills[app.position].status_rpa || '';
                $('.show_status_rpa').html(`TRẠNG THÁI ROBOT: ${status_rpa}`);
                $('#modal_show_rpa').modal('show');
            })
        })

        $(".btn_submit_up_po").on('click', function () {
            if($('.input_file_upload_po').val() == ''){
                alertSwalTopRight('info', 'Bạn chưa chọn file tải lên !!')
            }
            else{
                var form_up_po = new FormData(document.getElementById('form_upload_po'))
                $.ajax({
                    url : '{% url 'ajax_upload_pdf_po' %}',
                    type : 'post',
                    data : form_up_po,
                    contentType: false,
                    processData: false,
                    success : function (data) {
                        if(data.message == 'success'){
                            alertSwalTopRight('success', 'Tải lên thành công !!')
                            window.location.reload()
                        }
                        else{
                            alertSwalTopRight('info', data.message )
                        }
                    }
                })
            }
        })
    </script>

{% endblock %}