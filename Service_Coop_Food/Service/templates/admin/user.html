{% extends 'admin/base_admin.html' %}
{% load static %}
{% load pagination %}
{% block add_css %}
    <style>
        .box_search{
            padding: 10px;
            margin: 10px;
            border: 1px solid #1c7430;
        }
        .i-small-require {
            font-size: 8px !important;
            color: red !important;
        }
    </style>
{% endblock %}

{% block admin_function %}
{#    <button class="btn btn-outline-info" data-toggle="modal" data-target="#modal_add_user">Thêm người dùng mới <i class="fas fa-user-plus"></i></button>#}
    <a class="btn btn-outline-info" href="{% url 'admin_user_add' %}" ><i class="fas fa-user-plus"></i> Thêm người dùng mới</a>
    <button class="btn btn-outline-info btn-import-excel-user"><i class="fas fa-folder-plus"></i> Import </button>
    <button class="btn btn-outline-info btn-export-excel-user"><i class="far fa-file-excel"></i> Export </button>
{% endblock %}

{% block active_user %}
    <a href="{% url 'admin_user' %}" class="list-group-item list-group-item-action bg-light nav-link-active"><i class="fas fa-user-alt"></i> Quản lý
        người dùng</a>
{% endblock %}

{% block admin_content %}
    <div class="box-filter-admin-user">
        <form method="get" action="{% url 'admin_user' %}">
            <div class=" box_search">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" class="form-control" {% if name_search %} value="{{ name_search }}" {% endif %} placeholder="Nhập tên user cần tìm ..." name="input_search_user">
                        <input type="hidden" name="hidden_is_search_expend" id="hidden_is_search_expend" value="false">
                    </div>
                    <div class="col-md-3">
                        <button type="" class="btn btn-outline-info"><i class="fa fa-search"> </i> Tìm kiếm </button>
                    </div>
                    <div class="col-md-6 d-flex ">
                        <button class="btn btn-info ml-auto btn-expend-search" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                            <i class="fas fa-chevron-down    "></i> Nâng cao
                        </button>
                    </div>
                </div>
                <div class="collapse row mt-3" id="collapseExample">
                        <div class="form-group col-md-3">
                            {% comment %} <label for="">Chọn mô hình</label> {% endcomment %}
                            <select class="selectpicker show-tick"  id="select_site_filter_admin" name="select_site" data-style="btn-info" data-width="100%">
                                    {% for site in list_site %}
                                        {% if site.id == site_chosed %}
                                            <option value="{{ site.id }}" selected type='number'>{{ site.name }}</option>
                                        {% else %}
                                            <option value="{{ site.id }}" type='number'>{{ site.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            {% comment %} <label for="">Chọn Đơn vị </label> {% endcomment %}
                            <select class="selectpicker " data-live-search="true" id="select_branch_filter_admin" name="select_branch_filter_admin" data-style="btn-info" data-width="100%">
                                {% if cus_chosed == 'all' %}
                                    <option value="all" selected>Tất cả đơn vị</option>
                                {% else %}
                                    <option value="all" >Tất cả đơn vị</option>
                                {% endif %}
                                {% for cus in list_cus %}
                                    {% if cus.id == cus_chosed %}
                                        <option value="{{ cus.id }}" selected>{{ cus.name }}</option>
                                    {% else %}
                                        <option value="{{ cus.id }}">{{ cus.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            {% comment %} <label for="">Chọn vai trò </label> {% endcomment %}
                            <select class="selectpicker show-tick" data-live-search="true" id="select_role_filter_admin" name="select_role_filter_admin" multiple data-actions-box="true" data-style="btn-info" data-width="100%" data-selected-text-format="count > 1" data-count-selected-text= "Đã chọn {0} vai trò">
                                {% for role in list_role %}
                                    {% if role.id in role_chosed %}
                                        <option value="{{ role.id }}" selected>{{ role.name }}</option>
                                    {% else %}
                                        <option value="{{ role.id }}">{{ role.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                </div>
            </div>
        </form>
    </div>
    <div class="table-content " >
        <table class="table table-striped table-bordered table-sm" >
            <thead class="thead-dark text-center">
            <tr>
                <th scope="col" >STT</th>
                <th scope="col" style="min-width: 150px">Tên người dùng</th>
                <th scope="col" style="min-width: 150px">Mô hình</th>
                <th scope="col" style="min-width: 150px">Đơn vị</th>
                <th scope="col" style="min-width: 150px">Vai trò</th>
                <th scope="col" style="min-width: 300px">Quản lý các đơn vị</th>
{#                <th scope="col" style="min-width: 150px">Email</th>#}
{#                <th scope="col" style="min-width: 130px">Số Điện Thoại</th>#}
{#                <th scope="col" style="min-width: 200px">Địa Chỉ</th>#}
                <th scope="col" style="min-width: 200px">Ngày tạo</th>
                <th scope="col" style="min-width: 200px">Cập nhật cuối</th>
                <th scope="col" style="min-width: 150px">Thao Tác</th>
            </tr>
            </thead>
            <tbody>
                {% for user in list_user %}
                    <tr>
                        <td class="text-center align-middle">{{ list_user.start_index|add:forloop.counter0  }}</td>
                        <td class="align-middle">{{ user.username }}</td>
                        <td class="align-middle">{{ user.cus.site.name }}</td>
                        <td class="align-middle">{{ user.cus.name }}</td>
                        <td class="align-middle">{{ user.role.name }}</td>
                        <td  class="align-middle" style="word-wrap: break-word;max-width: 150px;">
                            {% for cus in user.manager_cus.all %}
                                {% if forloop.counter < 6 %}
                                    <p class="mt-0 mb-0"> {{ cus }}</p>
                                    {% else %}
                                    <p class="d-none mt-0 mb-0">{{ cus }}</p>
                                {% endif %}
                            {% endfor %}
                            {% if user.manager_cus.all|length > 5 %}
                                <div class="d-flex justify-content-end mb-0"> <a type="button" class="text-info wath-all-manager-cus">Xem tất cả ({{ user.manager_cus.all|length }}) </a> </div>
                            {% endif %}
                        </td>
{#                        <td class="align-middle">{{ user.email }}</td>#}
{#                        <td class="text-center align-middle">{% if user.phone_number %}{{ user.phone_number }}{% endif %}</td>#}
{#                        <td class="align-middle">{{ user.address }}</td>#}
                        <td class="text-center align-middle">{{ user.created_at|date:'d/m/Y H:m:s' }}</td>
                        <td class="text-center align-middle">{{ user.updated_at|date:'d/m/Y H:m:s' }}</td>
                        <td  class="text-center align-middle">
{#                            <a type="button" class="btn-edit-user btn btn-outline-info" title="Sửa thông tin người dùng" data-toggle="tooltip" data-placement="top" data-iduser = {{ user.id }} ><i class="far fa-edit"></i> </a>#}
                            <a class="btn btn-outline-info" title="Sửa thông tin người dùng"  href="{% url 'admin_user_edit' user.id %}"><i class="far fa-edit"></i> </a>
                            <a type="button" href="#" class="btn-reset-pass-user btn btn-outline-info" title="Khôi phục mật khẩu  người dùng" data-toggle="tooltip" data-placement="top" data-message="reset" data-iduser = {{ user.id }} ><i class="fas fa-redo"></i> </a>
                            <a type="button" href="#" class="btn-lock-user btn btn-outline-info" data-toggle="tooltip" data-placement="top" title="{% if user.is_lock  %}Mở khóa người dùng{% else %}Khóa người dùng{% endif %}"  data-message = "lock" data-iduser = {{ user.id }} >
                                {% if user.is_lock %}
                                    <i class="fas fa-lock-open"></i>
                                {% else %}
                                    <i class="fas fa-lock"></i>
                                {% endif %}
                            </a>
                        </td>
                    </tr>
                {% empty %}
                    <tr class="text-center"> <td colspan="13"> Không có kết quả nào được tìm thấy !</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{#    <div class="pagination d-flex justify-content-end">#}
{#        <span class="step-links">#}
{#        {% if list_user.has_previous %}#}
{#            <a href="?{% url_replace request 'page' '1' %}">Trang đầu tiên</a>#}
{#            <a href="?{% url_replace request 'page' list_user.previous_page_number %}">Trở lại trang trước</a>#}
{#        {% endif %}#}
{#            <span class="current">#}
{#            Trang {{ list_user.number }} / {{ list_user.paginator.num_pages }}.#}
{#        </span>#}
{##}
{#            {% if list_user.has_next %}#}
{#                <a href="?{% url_replace request 'page' list_user.next_page_number %}">Trang sau</a>#}
{#                <a href="?{% url_replace request 'page' list_user.paginator.num_pages %}">Trang cuối cùng</a>#}
{#            {% endif %}#}
{#    </span>#}
{#    </div>#}
    <nav aria-label="navigation">
        <ul class="pagination justify-content-end mb-4">
            <li class="sum-paginator" >Trang {{ list_user.number }}/{{ list_user.paginator.num_pages }} </li>
            {% if list_user.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% url_replace request 'page' list_user.previous_page_number %}">
                        <i class="fas fa-angle-left"></i>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#">
                        <i class="fas fa-angle-left"></i>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
            {% endif %}
            {% if list_user.number|add:'-4'  > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?{% url_replace request 'page' 1 %}">{{ 1 }}</a>
                </li>
                <li><a class="page-link" href="?{% url_replace request 'page' list_user.number|add:'-5' %}">&hellip;</a></li>
            {% endif %}

            {% for i in list_user.paginator.page_range %}
                {% if list_user.number == i %}
                    <li class="page-item active">
                        <a class="page-link" href="?{% url_replace request 'page' i %}">{{ list_user.number }}</a>
                    </li>
                {% elif i > list_user.number|add:'-5' and i < list_user.number|add:'5' %}
                    <li class="page-item">
                        <a class="page-link" href="?{% url_replace request 'page' i %}">{{ i }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if list_user.paginator.num_pages > list_user.number|add:'4' %}
{#                <li><a class="page-link" href="?page={{ page_obj.number|add:'5' }}">&hellip;</a></li>#}
                <li><a class="page-link" href="?{% url_replace request 'page' list_user.number|add:'5' %}">&hellip;</a></li>
                <li class="page-item">
                    <a class="page-link" href="?{% url_replace request 'page' list_user.paginator.num_pages %}">{{ list_user.paginator.num_pages }}</a>
                </li>
            {% endif %}

            {% if list_user.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% url_replace request 'page' list_user.next_page_number %}">
                        <i class="fas fa-angle-right"></i>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#">
                        <i class="fas fa-angle-right"></i>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>


    <!-- Modal show all cus manager -->
    <div class="modal fade" id="modal_show_all_cus_manager" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tất cả đơn vị Quản lý</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Body
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal">Đóng
                        <i class="fas fa-closed-captioning  "></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal-import-user-excel -->
    <div class="modal fade" id="modal_import_user_with_excel" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm người dùng bằng file Excel </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div>
                        <div class="form-group">
                            <label for="select_site_import_with_excel"> Chọn mô hình</label>
                            <select class="form-control" id="select_site_import_with_excel">
                                {% for site in list_site %}
                                    <option value="{{ site.id }}" type='number'>{{ site.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                             <button type="button" class="btn btn-info w-100 btn-dowload-example-import-user-excel">Tải mẫu Excel <i class="fas fa-download  "></i></button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-info w-100 btn-chose-file-export" onclick="document.getElementById('file_excel_import').click();">Chọn File <i class="fas fa-file-excel  "></i></button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-info w-100 btn-submit-import-file">Tải lên <i class="fas fa-upload  "></i></button>
                        </div>
                    </div>
                    <p class="name-excel-import text-center m-3"></p>
                    <form id="form-import-user-excel" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="file" name="file" id="file_excel_import" class="d-none" placeholder="" aria-describedby="helpId" accept=".xlsm">
                    </form>
                </div>
                <div class="modal-footer">
                    <p>
                        <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#contentId" aria-expanded="false"
                                aria-controls="contentId" title="Xem hướng dẫn">
                            <i class="fas fa-question-circle  "></i>
                        </button>
                    </p>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Đóng
                        <i class="fas fa-times  "></i></button>
                </div>
                <div class="collapse" id="contentId">
                    <div class="container m-3 ">
                        <p class="text-center font-weight-bold">HƯỚNG DẪN THÊM NGƯỜI DÙNG BẰNG FILE EXCEL</p>
                        - Bước 1 : Chọn mô hình và tải mẫu Excel về <br>
                        - Bước 2 : Mở File Excel và thêm các user<br>
                        - Bước 3 : Chọn File và nhấn tải lên
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if messages %}
    <div class="alert alert-add-success alert-dismissible d-none" >
        {% for message in messages %}
            {% if message.tags == 'success' %}{{ message }} {% endif %}
        {% endfor %}
    </div>
    {% endif %}
{% endblock %}

{% block add_js %}
    <script>
        $(document).ready(function () {
            if($('.alert-add-success').text() != ''){
                alertSwalTopRight('success', 'Thêm người dùng thành công')
            }

            $('#select_branch_filter_admin').selectpicker()

            $('.select-add-role').on('change' , function () {
                var role_val = $(this).val()
                if(role_val == 6){
                    $('.custom-add').html($('.temp-ttpp-hiden').html())
                }
                else if(role_val == 5){
                    $('.custom-add').html($('.temp-manager-hiden').html())
                    $('form .select-add-cus-manager').selectpicker()
                }
                else {
                    $('.custom-add').html($('.temp-accouting-hiden').html())
                }
            })

            $('.select-edit-role').on('change' , function () {
                var role_val = $(this).val()
                if(role_val == 6){
                    $('.custom-add-edit-user').html($('.temp-ttpp-hiden-edit').html())
                }
                else if(role_val == 5){
                    $('.custom-add-edit-user').html($('.temp-manager-hiden-edit').html())
                    $('form .select-edit-cus-manager').selectpicker()
                }
                else {
                    $('.custom-add-edit-user').html($('.temp-accouting-hiden-edit').html())
                }

            })

            ///add  new user
            $('.btn-submit-add-user').on('click', function () {
                form_add_user = $('#form_add_user')
                form_data_add_user = new FormData(document.getElementById('form_add_user'))
                $.ajax({
                    url : '{% url 'admin_user'  %}' ,
                    type : 'POST',
                    data : form_data_add_user,
                    processData: false,
                    contentType: false,
                    success : function (data) {
                        if (data.message_error){
                            html_error = data.message_error.join('<br> - ')
                            $('.div-message-error-add-user').html('- ' + html_error)
                        }
                        else {
                            $('#modal_add_user').modal('hide')
                            Swal.fire({
                                icon: 'success',
                                title: 'Thêm mới thành công',
                                showConfirmButton: true,
                            })
                        }
                    },
                    error: function (data) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Đã xảy ra lỗi, vui lòng thử lại sau. Xin cám ơn!!',
                        })
                    }

                })
            })

            //edit user
            $('.btn-edit-user').on('click', function () {
                $.ajax({
                    url : '{% url 'admin_user_edit'  %}' ,
                    type : 'GET',
                    data : {
                        'user_id' : $(this).data('iduser')
                    },
                    success : function (data) {
                        console.log(data.user[0].type_ttpp)
                        $('.input-edit-username').val(data.user[0].username)
                        $('.input-edit-email').val(data.user[0].email)
                        $('.input-edit-phone-number').val(data.user[0].phone_number)
                        $('.input-edit-password').val(data.user[0].password)
                        $('.select-edit-role').val(data.user[0].role_id)
                        $('.select-edit-cus').val(data.user[0].cus_id)
                        if(data.user[0].role_id == 10){
                            $('.select-edit-type-ttpp').val(data.user[0].type_ttpp)
                            $('.custom-add-edit-user').html($('.temp-ttpp-hiden-edit').html())
                        }
                        else if (data.user[0].role_id == 11) {
                            $('.custom-add-edit-user').html($('.temp-manager-hiden-edit').html())
                            try {
                                var arr = JSON.parse("[" + data.user[0].manager_cus + "]")
                            }
                            catch (e) {
                                var arr = []
                            }
                            $('.select-edit-cus-manager').val(arr)
                            $('form .select-edit-cus-manager').selectpicker()
                        }
                        else {
                            $('.custom-add-edit-user').html($('.temp-accouting-hiden-edit').html())
                        }
                        $('#modal_edit_user').modal('show')
                    },
                    error: function (data) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Đã xảy ra lỗi, vui lòng thử lại sau. Xin cám ơn!!',
                        })
                    }

                })
            })


            $('.btn-submit-edit-user').on('click', function () {
                conf = confirm('Bạn muốn thay đổi thông tin user này??')
                if(conf == false){
                    return false
                }
                form_edit = $('#form_edit_user')
                form_data_edit = new FormData(document.getElementById('form_edit_user'))
                $.ajax({
                    url : '{% url 'admin_user_edit'  %}' ,
                    type : 'POST',
                    data : form_data_edit,
                    processData: false,
                    contentType: false,
                    success : function (data) {
                        if (data.message_error){
                            html_error = data.message_error.join('<br> - ')
                            $('.div-message-error-edit-user').html('- ' + html_error)
                        }
                        else {
                            $('#modal_add_user').modal('hide')
                            Swal.fire({
                                icon: 'success',
                                title: 'Sửa thông tin user thành công',
                                showConfirmButton: true,
                            })
                        }
                    },
                    error: function (data) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Đã xảy ra lỗi, vui lòng thử lại sau. Xin cám ơn!!',
                        })
                    }

                })
            })

            //Reset Pass
            $('.btn-reset-pass-user, .btn-lock-user').on('click' , function () {
                id_user = $(this).data('iduser')
                messsge = $(this).data('message')
                old_element = $(this)
                if(messsge == 'reset'){
                    text = "Khôi phục mật khẩu cho tài khoản này!"
                }else {
                    if ( $(this).attr("title") == 'Mở khóa người dùng'){
                        text = "Mở khóa cho tài khoản này!"
                    }else{
                        text = "Khóa tài khoản này!"
                    }

                }
                Swal.fire({
                    title: 'Bạn có chắc chắn?',
                    text: text,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: 'green',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Có, chắc chắn',
                    cancelButtonText: 'Không',
                }).then((result) => {
                    if (result.value) {
                        $.ajax({
                            url : "{% url 'admin_user_reset_pass'  %}",
                            type : 'POST',
                            data: {
                                'message' : messsge,
                                'id' : id_user,
                                'csrfmiddlewaretoken' : '{{ csrf_token }}'
                            },
                            success: function (data) {
                                if(data.message_success){
                                    if (messsge != 'reset') {
                                        if (data.lock_status == 0) {
                                            old_element.html('<i class="fas fa-lock"></i>');
                                            old_element.attr("title","Khóa người dùng");
                                        } else {
                                            old_element.html('<i class="fas fa-lock-open"></i>')
                                            old_element.attr("title", "Mở khóa người dùng");
                                        }
                                    }
                                    Swal.fire({
                                        title : 'Thành công!',
                                        icon : 'success'
                                    })
                                }
                            },
                            error: function (data) {

                            }
                        })
                    }
                })
            })

            $('#select_site_filter_admin').on('change' ,function () {
                $.ajax({
                    url : '{% url 'ajax_change_option_site_add_user'  %}' ,
                    type : 'get',
                    data : {
                        'site_id' : $('#select_site_filter_admin').val()
                    },
                    success : function (data) {
                        console.log(data)
                        html_role = ""
                        html_cus = '<option value="all">Tất cả đơn vị</option>'
                        data.list_rol_site.forEach(function (element) {
                            html_role += "<option value='"+element[0]+"'> " +element[1]+"</option>"
                        })
                        $('#select_role_filter_admin').html(html_role)
                        data.list_cus_site.forEach(function (element) {
                            html_cus += "<option value='"+element[0]+"'> " +element[1]+"</option>"
                        })
                        $('#select_branch_filter_admin').html(html_cus)
                        {#$('form .select-add-cus-manager').val(1)#}
                        $('#select_branch_filter_admin').selectpicker('refresh')
                        $('#select_role_filter_admin').selectpicker('refresh')
                    },
                    error: function (data) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Đã xảy ra lỗi, vui lòng thử lại sau. Xin cám ơn!!',
                        })
                    }

                })
            })

            ///serarch expend
            $('.btn-expend-search').on( 'click',function () {
                if(!$(this).hasClass('collapsed')){
                    $('#hidden_is_search_expend').val('true')
                }
                else{
                    $('#hidden_is_search_expend').val('false')
                }
            })

            if('{{ is_search_expend }}' == 'true'){
                console.log("oepn")
                $('.btn-expend-search').click()
            }

            //wathch all cusmanager
            $('.wath-all-manager-cus').on('click', function () {
                html = ''
                $(this).closest('td').find('p').each(function (i) {
                    html += '<p class="mt-0 mb-0">' + (parseInt(i) + 1) + '-' + $(this).text() + '</p>'
                })
                $('#modal_show_all_cus_manager .modal-body').html(html)
                $('#modal_show_all_cus_manager').modal('show')
            })

            //export excel user
            $('.btn-export-excel-user').on( 'click', function () {
                path_seach_curent = window.location.search
                window.location.href = '/admin/user/export_excel' + path_seach_curent
            })

            //import user with excel
            $('.btn-import-excel-user').on('click', function () {
                $('.name-excel-import').text('')
                $('#modal_import_user_with_excel').modal('show')
            })

            $('#modal_import_user_with_excel').on('hidden.bs.modal', function (e) {
              $('#file_excel_import').val('')
            })

            $('#file_excel_import').on('change', function () {
                $('.name-excel-import').text('File đã chọn: ' + $(this).val())
            })

            $('.btn-submit-import-file').on('click' ,function () {
                if (!$('#file_excel_import').val()){
                    Swal.fire({
                        position: 'top-end',
                        icon: 'error',
                        title: 'Bạn chưa tải File lên, Vui lòng chọn File rồi thử lại',
                        showConfirmButton: false,
                        timer: 1500,
                        customClass: 'custom-sweetalert-right'
                    })
                }else {
                    var form_import_excel = new FormData(document.getElementById('form-import-user-excel'))
                    form_import_excel.append('site', $('#select_site_import_with_excel').val())
                    $.ajax({
                        url : "{% url 'admin_user_import_excel' %}",
                        type : 'post',
                        data : form_import_excel,
                        processData : false,
                        contentType : false,
                        success: function (data) {
                            console.log(data)
                            $('#modal_import_user_with_excel').modal('hide')
                            Swal.fire({
                                title: 'Tải lên thành công',
                                icon: 'success',
                                html:
                                    'Thành công : ' + data.count_success +
                                    '<br>Thất bại : ' + data.count_fail +
                                    '<br><a href="/admin/user/import_excel/dowload_base_file?type=dowload_report">Tải báo cáo</a> ',
                                showCloseButton: true,
                                showConfirmButton: false,
                                showCancelButton: false,
                                {#focusConfirm: false,#}
                                {#confirmButtonText:#}
                                {#    '<i class="fa fa-thumbs-up"></i> Great!',#}
                                {#confirmButtonAriaLabel: 'Thumbs up, great!',#}
                                {#cancelButtonText:#}
                                {#    '<i class="fa fa-thumbs-down"></i>',#}
                                {#cancelButtonAriaLabel: 'Thumbs down'#}
                            })
                        }

                    })
                }
            })

            $('.btn-dowload-example-import-user-excel').on('click', function () {
                window.location.href = '/admin/user/import_excel/dowload_base_file?site=' + $('#select_site_import_with_excel').val()
            })
        })
    </script>
{% endblock %}